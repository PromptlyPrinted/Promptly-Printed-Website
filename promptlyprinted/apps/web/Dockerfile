# syntax=docker/dockerfile:1.7-labs

FROM node:22-bookworm-slim AS base

ENV PNPM_HOME="/usr/local/share/pnpm" \
    PATH="/usr/local/share/pnpm:$PATH" \
    PNPM_STORE_DIR="/root/.pnpm-store" \
    NEXT_TELEMETRY_DISABLED=1

RUN corepack enable && \
    apt-get update && \
    apt-get install -y --no-install-recommends python3 make g++ libvips && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

FROM base AS deps

COPY package.json pnpm-workspace.yaml pnpm-lock.yaml turbo.json ./
COPY turbo ./turbo
COPY packages ./packages
COPY apps ./apps

RUN --mount=type=cache,id=promptlyprinted-pnpm-store,target=/root/.pnpm-store \
    pnpm install --frozen-lockfile

FROM deps AS build

ARG BETTER_AUTH_SECRET
ARG BETTER_AUTH_URL
ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET
ARG APPLE_CLIENT_ID
ARG APPLE_CLIENT_SECRET
ARG GITHUB_CLIENT_ID
ARG GITHUB_CLIENT_SECRET
ARG CLERK_SECRET_KEY
ARG CLERK_WEBHOOK_SECRET
ARG RESEND_AUDIENCE_ID
ARG RESEND_FROM
ARG DATABASE_URL
ARG PULSE_API_KEY
ARG RESEND_TOKEN
ARG STRIPE_SECRET_KEY
ARG STRIPE_WEBHOOK_SECRET
ARG BETTERSTACK_API_KEY
ARG BETTERSTACK_URL
ARG FLAGS_SECRET
ARG ARCJET_KEY
ARG SVIX_TOKEN
ARG LIVEBLOCKS_SECRET
ARG BASEHUB_TOKEN
ARG BASEHUB_ADMIN_TOKEN
ARG NEXT_PUBLIC_BETTER_AUTH_URL
ARG NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ARG NEXT_PUBLIC_CLERK_SIGN_IN_URL
ARG NEXT_PUBLIC_CLERK_SIGN_UP_URL
ARG NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL
ARG NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL
ARG NEXT_PUBLIC_GA_MEASUREMENT_ID
ARG NEXT_PUBLIC_POSTHOG_KEY
ARG NEXT_PUBLIC_POSTHOG_HOST
ARG NEXT_PUBLIC_DOCS_URL
ARG NEXT_PUBLIC_APP_URL
ARG NEXT_PUBLIC_WEB_URL
ARG NEXT_PUBLIC_VERCEL_PROJECT_PRODUCTION_URL
ARG NEXT_PUBLIC_API_URL
ARG NEXTAUTH_URL
ARG NEXTAUTH_SECRET
ARG PRODIGI_API_KEY
ARG PRODIGI_API
ARG SQUARE_ACCESS_TOKEN
ARG SQUARE_LOCATION_ID
ARG SQUARE_ENVIRONMENT
ARG SQUARE_WEBHOOK_SIGNATURE_KEY
ARG GOOGLE_GEMINI_API_KEY
ARG TOGETHER_API_KEY
ARG POSTHOG_API_KEY
ENV BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET} \
    BETTER_AUTH_URL=${BETTER_AUTH_URL} \
    GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID} \
    GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET} \
    APPLE_CLIENT_ID=${APPLE_CLIENT_ID} \
    APPLE_CLIENT_SECRET=${APPLE_CLIENT_SECRET} \
    GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID} \
    GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET} \
    CLERK_SECRET_KEY=${CLERK_SECRET_KEY} \
    CLERK_WEBHOOK_SECRET=${CLERK_WEBHOOK_SECRET} \
    RESEND_AUDIENCE_ID=${RESEND_AUDIENCE_ID} \
    RESEND_FROM=${RESEND_FROM} \
    DATABASE_URL=${DATABASE_URL} \
    PULSE_API_KEY=${PULSE_API_KEY} \
    RESEND_TOKEN=${RESEND_TOKEN} \
    STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY} \
    STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET} \
    BETTERSTACK_API_KEY=${BETTERSTACK_API_KEY} \
    BETTERSTACK_URL=${BETTERSTACK_URL} \
    FLAGS_SECRET=${FLAGS_SECRET} \
    ARCJET_KEY=${ARCJET_KEY} \
    SVIX_TOKEN=${SVIX_TOKEN} \
    LIVEBLOCKS_SECRET=${LIVEBLOCKS_SECRET} \
    BASEHUB_TOKEN=${BASEHUB_TOKEN} \
    BASEHUB_ADMIN_TOKEN=${BASEHUB_ADMIN_TOKEN} \
    NEXT_PUBLIC_BETTER_AUTH_URL=${NEXT_PUBLIC_BETTER_AUTH_URL} \
    NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY} \
    NEXT_PUBLIC_CLERK_SIGN_IN_URL=${NEXT_PUBLIC_CLERK_SIGN_IN_URL} \
    NEXT_PUBLIC_CLERK_SIGN_UP_URL=${NEXT_PUBLIC_CLERK_SIGN_UP_URL} \
    NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=${NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL} \
    NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=${NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL} \
    NEXT_PUBLIC_GA_MEASUREMENT_ID=${NEXT_PUBLIC_GA_MEASUREMENT_ID} \
    NEXT_PUBLIC_POSTHOG_KEY=${NEXT_PUBLIC_POSTHOG_KEY} \
    NEXT_PUBLIC_POSTHOG_HOST=${NEXT_PUBLIC_POSTHOG_HOST} \
    NEXT_PUBLIC_DOCS_URL=${NEXT_PUBLIC_DOCS_URL} \
    NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL} \
    NEXT_PUBLIC_WEB_URL=${NEXT_PUBLIC_WEB_URL} \
    NEXT_PUBLIC_VERCEL_PROJECT_PRODUCTION_URL=${NEXT_PUBLIC_VERCEL_PROJECT_PRODUCTION_URL} \
    NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL} \
    NEXTAUTH_URL=${NEXTAUTH_URL} \
    NEXTAUTH_SECRET=${NEXTAUTH_SECRET} \
    PRODIGI_API_KEY=${PRODIGI_API_KEY} \
    PRODIGI_API=${PRODIGI_API} \
    SQUARE_ACCESS_TOKEN=${SQUARE_ACCESS_TOKEN} \
    SQUARE_LOCATION_ID=${SQUARE_LOCATION_ID} \
    SQUARE_ENVIRONMENT=${SQUARE_ENVIRONMENT} \
    SQUARE_WEBHOOK_SIGNATURE_KEY=${SQUARE_WEBHOOK_SIGNATURE_KEY} \
    GOOGLE_GEMINI_API_KEY=${GOOGLE_GEMINI_API_KEY} \
    TOGETHER_API_KEY=${TOGETHER_API_KEY} \
    POSTHOG_API_KEY=${POSTHOG_API_KEY}

ENV NODE_ENV=production

COPY . .
RUN --mount=type=cache,id=promptlyprinted-pnpm-store,target=/root/.pnpm-store \
    pnpm --filter web build

FROM node:22-bookworm-slim AS runner

ENV NODE_ENV=production \
    NEXT_TELEMETRY_DISABLED=1

RUN apt-get update && \
    apt-get install -y --no-install-recommends libvips curl && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy the standalone output
COPY --from=build /workspace/apps/web/.next/standalone ./
COPY --from=build /workspace/apps/web/.next/static ./apps/web/.next/static
COPY --from=build /workspace/apps/web/public ./apps/web/public

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Start from the apps/web directory where server.js exists
WORKDIR /app/apps/web
CMD ["node", "server.js"]
