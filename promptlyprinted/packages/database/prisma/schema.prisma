generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String       @id @default(cuid())
  email            String       @unique
  emailVerified    Boolean      @default(false)
  name             String?
  firstName        String?
  lastName         String?
  image            String?
  role             Role         @default(CUSTOMER)
  stripeCustomerId String?      @unique
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  // Better Auth plugin fields
  username               String?  @unique // Username plugin
  phoneNumber           String?  @unique // Phone number plugin
  phoneNumberVerified   Boolean  @default(false) // Phone number plugin
  twoFactorEnabled      Boolean  @default(false) // Two factor plugin
  banned                Boolean  @default(false) // Admin plugin
  banReason             String? // Admin plugin
  banExpiresAt          DateTime? // Admin plugin
  
  // Relationships
  addresses   Address[]
  Analytics   Analytics[]
  orders      Order[]      @relation("UserOrders")
  savedImages SavedImage[]
  wishlist    Product[]    @relation("UserWishlist")
  designs     Design[]
  sessions    Session[]
  accounts    Account[]
  twoFactor   TwoFactor? // Two factor plugin relationship
  competitionEntries CompetitionEntry[]
  votes       Vote[]
  likes       Like[]
  userPoints  UserPoints?
  pointHistory PointHistory[]
}

model Page {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id                     Int          @id @default(autoincrement())
  name                   String
  sku                    String
  description            String
  price                  Float
  customerPrice          Float
  stock                  Int          @default(0)
  currency               String
  categoryId             Int?
  productType            String
  listed                 Boolean      @default(false)
  isActive               Boolean      @default(true)
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  brand                  String
  color                  String[]
  countryCode            String
  edge                   String
  fulfillmentCountryCode String?
  fulfillmentLabCode     String?
  gender                 String
  height                 Float
  shippingCost           Float
  size                   String[]
  style                  String
  taxAmount              Float
  totalCost              Float
  units                  String
  width                  Float
  prodigiAttributes      Json?
  prodigiDescription     String?
  prodigiPrintAreas      Json?
  prodigiVariants        Json?

  // Variant support
  isVariantProduct       Boolean      @default(false)  // True if this product has variants
  parentProductId        Int?                          // Reference to parent if this is a variant
  variantAttributes      Json?                         // Stores variant-specific attributes (e.g., {"size": "38mm", "finish": "Rose Gold"})

  images                 Image[]
  category               Category?    @relation(fields: [categoryId], references: [id])
  quotes                 Quote[]
  savedImages            SavedImage[]
  wishedBy               User[]       @relation("UserWishlist")
  designs                Design[]
  prices                 ProductPrice[]
  translations           ProductTranslation[]

  // Variant relationships
  parentProduct          Product?     @relation("ProductVariants", fields: [parentProductId], references: [id])
  variants               Product[]    @relation("ProductVariants")
  variantOptions         ProductVariantOption[]

  @@unique([sku, countryCode])
  @@index([countryCode])
  @@index([categoryId])
  @@index([productType])
  @@index([listed])
  @@index([createdAt])
  @@index([parentProductId])
  @@index([isVariantProduct])
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  description String?
  isActive    Boolean   @default(true)
  products    Product[]
}

model Order {
  id                 Int                    @id @default(autoincrement())
  prodigiOrderId     String?                @unique
  userId             String
  status             OrderStatus            @default(PENDING)
  totalPrice         Float
  discountCodeId     String?
  discountAmount     Float?
  stripeSessionId    String?
  paymentId          Int?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  callbackUrl        String?
  idempotencyKey     String?
  merchantReference  String?
  metadata           Json?
  outcome            String?
  packingSlip        String?
  prodigiCreatedAt   DateTime?
  prodigiLastUpdated DateTime?
  prodigiStage       String?
  prodigiStatusJson  Json?
  shippingMethod     ShippingMethod?
  traceParent        String?
  charges            Charge[]
  payment            Payment?               @relation(fields: [paymentId], references: [id])
  user               User                   @relation("UserOrders", fields: [userId], references: [id])
  discountCode       DiscountCode?          @relation("OrderDiscount", fields: [discountCodeId], references: [id])
  orderItems         OrderItem[]
  prodigiErrors      OrderProcessingError[]
  recipient          Recipient?
  shipments          Shipment[]             @relation("OrderShipments")
}

model OrderItem {
  id                    Int            @id @default(autoincrement())
  orderId               Int
  productId             Int?
  copies                Int            @default(1)
  price                 Float
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  assets                Json?
  attributes            Json?
  merchantReference     String?
  prodigiItemId         String?
  prodigiItemStatus     String?
  recipientCostAmount   Float?
  recipientCostCurrency String?
  sizing                String?
  customizationId       Int?
  customization         Customization? @relation(fields: [customizationId], references: [id])
  order                 Order          @relation(fields: [orderId], references: [id])
}

model Payment {
  id        Int      @id @default(autoincrement())
  stripeId  String   @unique
  status    String
  amount    Float
  currency  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Order     Order[]
}

model Image {
  id        Int      @id @default(autoincrement())
  url       String
  productId Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product? @relation(fields: [productId], references: [id])
}

model Analytics {
  id        Int      @id @default(autoincrement())
  userId    String?
  eventName String
  eventData Json
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model Log {
  id        Int      @id @default(autoincrement())
  level     String
  message   String
  metadata  Json
  createdAt DateTime @default(now())
}

model Address {
  id         String      @id @default(cuid())
  userId     String
  type       AddressType
  street     String
  city       String
  state      String
  postalCode String
  country    String
  isDefault  Boolean     @default(false)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  user       User        @relation(fields: [userId], references: [id])
}

model WebhookLog {
  id        String   @id @default(cuid())
  type      String
  status    String
  response  String
  createdAt DateTime @default(now())
}

model Recipient {
  id           Int     @id @default(autoincrement())
  name         String
  email        String?
  phoneNumber  String?
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String
  countryCode  String
  orderId      Int?    @unique
  order        Order?  @relation(fields: [orderId], references: [id])
}

model Charge {
  id                   Int          @id @default(autoincrement())
  prodigiChargeId      String?
  chargeType           String?
  prodigiInvoiceNumber String?
  costId               Int?
  orderId              Int
  totalCost            Cost?        @relation(fields: [costId], references: [id])
  order                Order        @relation(fields: [orderId], references: [id])
  items                ChargeItem[]
}

model ChargeItem {
  id            Int     @id @default(autoincrement())
  prodigiItemId String?
  shipmentId    String?
  costId        Int?
  chargeId      Int
  charge        Charge  @relation(fields: [chargeId], references: [id])
  cost          Cost?   @relation(fields: [costId], references: [id])
}

model Cost {
  id                 Int                @id @default(autoincrement())
  amount             String?
  currency           String?
  charges            Charge[]
  chargeItems        ChargeItem[]
  quoteItemsCosts    QuoteCostSummary[] @relation("QuoteItemsCost")
  quoteShippingCosts QuoteCostSummary[] @relation("QuoteShippingCost")
  quoteItems         QuoteItem[]
  quoteShipments     QuoteShipment[]
}

model Shipment {
  id                    Int                  @id @default(autoincrement())
  prodigiShipmentId     String?              @unique
  status                String?
  carrier               String?
  carrierService        String?
  trackingUrl           String?
  trackingNumber        String?
  dispatchDate          DateTime?
  fulfillmentLocationId Int?
  orderId               Int
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  fulfillmentLocation   FulfillmentLocation? @relation(fields: [fulfillmentLocationId], references: [id])
  order                 Order                @relation("OrderShipments", fields: [orderId], references: [id], map: "Shipment_orderId_fkey")
  items                 ShipmentItem[]

  @@index([orderId])
}

model ShipmentItem {
  id         Int      @id @default(autoincrement())
  itemId     String?
  shipmentId Int
  createdAt  DateTime @default(now())
  shipment   Shipment @relation(fields: [shipmentId], references: [id])

  @@index([shipmentId])
}

model FulfillmentLocation {
  id             Int             @id @default(autoincrement())
  countryCode    String?
  labCode        String?
  quoteShipments QuoteShipment[]
  shipments      Shipment[]
}

model Quote {
  id                     Int               @id @default(autoincrement())
  shipmentMethod         ShippingMethod?
  costSummaryId          Int?
  issues                 Json?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  currencyCode           String            @default("USD")
  destinationCountryCode String
  outcome                String?
  productId              Int?
  costSummary            QuoteCostSummary? @relation(fields: [costSummaryId], references: [id])
  product                Product?          @relation(fields: [productId], references: [id])
  items                  QuoteItem[]
  shipments              QuoteShipment[]
}

model QuoteCostSummary {
  id             Int     @id @default(autoincrement())
  itemsCostId    Int?
  shippingCostId Int?
  quotes         Quote[]
  items          Cost?   @relation("QuoteItemsCost", fields: [itemsCostId], references: [id])
  shipping       Cost?   @relation("QuoteShippingCost", fields: [shippingCostId], references: [id])
}

model QuoteShipment {
  id                    Int                  @id @default(autoincrement())
  carrierName           String?
  carrierService        String?
  costId                Int?
  fulfillmentLocationId Int?
  itemIds               Json?
  quoteId               Int
  cost                  Cost?                @relation(fields: [costId], references: [id])
  fulfillmentLocation   FulfillmentLocation? @relation(fields: [fulfillmentLocationId], references: [id])
  quote                 Quote                @relation(fields: [quoteId], references: [id])
}

model QuoteItem {
  id         Int     @id @default(autoincrement())
  quoteId    Int
  itemId     String?
  sku        String
  copies     Int
  costId     Int?
  attributes Json?
  assets     Json?
  unitCost   Cost?   @relation(fields: [costId], references: [id])
  quote      Quote   @relation(fields: [quoteId], references: [id])
}

model ProdigiCallbackEvent {
  id              String    @id @default(cuid())
  outcome         String?
  traceParent     String?
  eventId         String?
  specVersion     String?
  eventType       String?
  source          String?
  subject         String?
  dataContentType String?
  occurredAt      DateTime?
  data            Json?
  createdAt       DateTime  @default(now())
}

model ShippingPrice {
  id                  Int            @id @default(autoincrement())
  method              ShippingMethod
  basePrice           Float
  additionalItemPrice Float
  currency            String
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@unique([method, currency])
}

model SavedImage {
  id        String   @id @default(cuid())
  url       String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  productId Int?
  product   Product? @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  designs   Design[]

  @@index([userId])
  @@index([productId])
}

model Design {
  id           Int        @id @default(autoincrement())
  name         String
  userId       String
  productId    Int
  savedImageId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  user         User       @relation(fields: [userId], references: [id])
  product      Product    @relation(fields: [productId], references: [id])
  savedImage   SavedImage @relation(fields: [savedImageId], references: [id])
  competitionEntries CompetitionEntry[]

  @@index([userId])
  @@index([productId])
  @@index([savedImageId])
}

model Customization {
  id         Int         @id @default(autoincrement())
  artworkUrl String
  mockupUrl  String
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  orderItems OrderItem[]
}

model OrderProcessingError {
  id          Int       @id @default(autoincrement())
  orderId     Int
  error       String
  retryCount  Int
  lastAttempt DateTime?
  createdAt   DateTime  @default(now())
  resolvedAt  DateTime?
  resolvedBy  String?
  resolution  String?
  order       Order     @relation(fields: [orderId], references: [id])

  @@index([orderId])
}

model ProductPrice {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productId], references: [id])
  productId Int
  currency String
  amount   Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, currency])
}

model ProductTranslation {
  id          Int      @id @default(autoincrement())
  product     Product  @relation(fields: [productId], references: [id])
  productId   Int
  languageCode String
  name        String
  description String
  features    Json?
  ecoProperties Json?
  careInstructions Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([productId, languageCode])
}

model ProductVariantOption {
  id          Int      @id @default(autoincrement())
  productId   Int
  optionName  String   // e.g., "Size", "Finish", "Color"
  optionValue String   // e.g., "38mm", "Rose Gold", "Black"
  displayOrder Int     @default(0) // Order in which to display options
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, optionName, optionValue])
  @@index([productId])
}

enum Role {
  CUSTOMER
  ADMIN
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELED
}

enum AddressType {
  SHIPPING
  BILLING
}

enum ShippingMethod {
  BUDGET
  STANDARD
  EXPRESS
  OVERNIGHT
}

// Better Auth Models
model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  accountId         String
  providerId        String
  userId            String
  type              String  @default("credential")
  accessToken       String?
  refreshToken      String?
  idToken           String?
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?
  scope             String?
  password          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model TwoFactor {
  id          String    @id @default(cuid())
  secret      String
  backupCodes String?
  userId      String    @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Competition System Models
model Competition {
  id          String   @id @default(cuid())
  theme       String
  themeIcon   String
  prize       String
  startDate   DateTime
  endDate     DateTime
  description String   @db.Text
  funnelTag   String   @unique
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  entries CompetitionEntry[]
  votes   Vote[]

  @@index([funnelTag])
  @@index([isActive, endDate])
}

model CompetitionEntry {
  id            String   @id @default(cuid())
  competitionId String
  userId        String
  designId      Int
  submittedAt   DateTime @default(now())

  competition Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  design      Design      @relation(fields: [designId], references: [id], onDelete: Cascade)
  votes       Vote[]
  likes       Like[]

  @@unique([competitionId, designId])
  @@index([competitionId, userId])
  @@index([competitionId])
}

model Vote {
  id            String   @id @default(cuid())
  userId        String
  entryId       String
  competitionId String
  createdAt     DateTime @default(now())

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  entry       CompetitionEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  competition Competition      @relation(fields: [competitionId], references: [id], onDelete: Cascade)

  @@unique([userId, entryId])
  @@index([entryId])
  @@index([competitionId])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  entryId   String
  createdAt DateTime @default(now())

  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  entry CompetitionEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@unique([userId, entryId])
  @@index([entryId])
}

model UserPoints {
  id        String   @id @default(cuid())
  userId    String   @unique
  points    Int      @default(0)
  level     Int      @default(1)
  streak    Int      @default(0)
  lastActiveDate DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  history PointHistory[]

  @@index([points])
  @@index([level])
}

model PointHistory {
  id          String   @id @default(cuid())
  userId      String
  points      Int
  action      String
  description String?
  createdAt   DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade, map: "PointHistory_user_fkey")
  userPoints UserPoints @relation(fields: [userId], references: [userId], onDelete: Cascade, map: "PointHistory_userPoints_fkey")

  @@index([userId, createdAt])
}

// Discount Code Models
model DiscountCode {
  id              String   @id @default(cuid())
  code            String   @unique
  type            DiscountType
  value           Float    // Percentage (e.g., 10 for 10%) or fixed amount
  minOrderAmount  Float?   // Minimum order amount required
  maxUses         Int?     // Maximum total uses (null = unlimited)
  maxUsesPerUser  Int?     // Maximum uses per user (null = unlimited)
  usedCount       Int      @default(0)
  startsAt        DateTime?
  expiresAt       DateTime?
  isActive        Boolean  @default(true)
  metadata        Json?    // Additional metadata (e.g., source, campaign)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  orders          Order[]  @relation("OrderDiscount")
  usages          DiscountUsage[]

  @@index([code])
  @@index([isActive, expiresAt])
}

model DiscountUsage {
  id             String       @id @default(cuid())
  discountCodeId String
  orderId        Int
  userId         String?
  discountAmount Float
  createdAt      DateTime     @default(now())

  discountCode   DiscountCode @relation(fields: [discountCodeId], references: [id], onDelete: Cascade)

  @@index([discountCodeId])
  @@index([userId])
  @@index([orderId])
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}
